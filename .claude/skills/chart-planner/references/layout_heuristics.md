# Layout Heuristics

## 基本レイアウトパラメータ

| パラメータ | デフォルト値 | 自動調整ルール |
|---|---|---|
| lane_height | 200 | レーン内ノード数 > 2 の場合: 200 + (ノード数 - 2) × 60 |
| col_width | 420 | カラム内ノード数 > 2 の場合: 420 + (ノード数 - 2) × 100 |
| left_label_width | 260 | 最長部門名(日本語) × 16px + 60px (padding), 最小260 |
| header_height | 80 | 固定 |
| frame_padding | 200 | 固定 |
| task_w | 160 | ラベル幅が超える場合は拡大（日本語8文字で128px程度） |
| task_h | 80 | 固定 |
| decision_w | 110 | 日本語ラベル2行を収容するため90→110に拡大 |
| decision_h | 110 | decision_w と同一にする |
| chip_w | 130 | 日本語ラベルを収容するため90→130に拡大 |
| chip_h | 28 | 固定 |

## レーン順序の最適化（★重要）

レーンの並び順はコネクタの交差回数に直結する。以下のルールに従って最適化すること。

### 基本原則
1. **隣接性原則**: エッジで直接接続されるノードが多いレーン同士を隣接させる
2. **分岐近接原則**: decision ノードの分岐先レーンは、decision のあるレーンに隣接させる
3. **空レーン回避原則**: フロー後半で使われないレーンが、アクティブなレーン間に挟まれないようにする

### 最適化手順（貪欲法ベース）

1. **エッジマトリクス作成**: 全エッジについて、src ノードのレーンと dst ノードのレーンの組をカウントし、レーン間エッジ数の対称行列を作成する
2. **重心計算**: 各レーン L について、接続先レーンの現在位置(index)をエッジ数で重み付け平均した値を「接続重心」とする
   - `gravity(L) = Σ(edge_count(L, M) × index(M)) / Σ(edge_count(L, M))`
3. **並び替え**: 接続重心の昇順でレーンをソートする
4. **反復**: 並び替え後に重心を再計算し、順序が安定するまで最大3回繰り返す
5. **手動調整**: フロー開始レーン（start ノードのレーン）を先頭に固定し、フロー終了レーン（end ノードのレーン）を末尾寄りに配置する

### 具体例

悪い例（交差が多い）:
```
ベンダー → メールサーバー → システム → OCR/AI解析 → ストレージ → DB → マネージャー
```
- システム（DEC_CONF）→ DB（AUTO_REG）：間にOCR/AI解析とストレージが挟まる
- システム（DEC_CONF）→ マネージャー（REQ_CONFIRM/REQ_MANUAL）：3レーンをまたぐ

良い例（交差が少ない）:
```
ベンダー → メールサーバー → OCR/AI解析 → ストレージ → システム → DB → マネージャー
```
- OCR/AI解析とストレージはフロー前半のみ使用 → 上部にまとめる
- システム → DB：隣接（1レーン差）
- システム → マネージャー：2レーン差で最小

### チェックリスト
- [ ] decision ノードの全分岐先レーンが decision レーンの ±2 レーン以内にあるか
- [ ] フロー後半（右側カラム）で使われないレーンが中間に挟まっていないか
- [ ] 最もエッジが多いレーン間の距離が最小化されているか

## カラムの統合（★重要）

不要なカラム分割はチャートの横幅を増やし、コネクタの水平距離を長くする。以下のルールに従ってカラムを統合すること。

### 統合ルール
1. **判定統合**: decision ノードとその直前の処理ノードが同一レーンにある場合、同一カラムに統合できる（dx オフセットで水平に並べる）
2. **空カラム回避**: ノードが1-2個しかないカラムは、隣接カラムへの統合を検討する
3. **目安**: 7カラム以下を目標とする（8カラム以上は横幅が過大になりやすい）

### 統合例
```
Before: ... | AI解析 | 信頼度判定 | 自動処理 | ...   （8カラム）
After:  ... | AI解析・判定 | 自動処理 | ...             （7カラム）
```
AI解析の最終ステップ（RETURN_DATA）と判定（DEC_CONF）を同一カラムで dx オフセットにより配置。

## 同一セル内の複数ノード配置

同一セル（同一 lane × 同一 col）に複数のフローノード（task/decision/start/end）がある場合:

### 2ノードの場合
```
Node A: dx = -100, dy = 0
Node B: dx = +100, dy = 0
```

### 3ノードの場合
```
Node A: dx = -160, dy = 0
Node B: dx = 0 (or +10), dy = 0
Node C: dx = +160, dy = 0
```

### 一般規則
- N個のノードを水平方向に等間隔配置
- 間隔: 170px（task_w + 10px マージン）
- 中央を基点に左右対称配置
- decision ノードは task ノードより幅が広い（110px）ため、間隔を10px追加

## chip ノードの配置

chip ノードは対応する親ノード（task/decision）の直下に配置:
- dx: 親ノードと同じ dx
- dy: 親ノードの dy + 70

## start/end ノードの配置

- start ノード: 最初のカラム (col=0) の左端に配置、dx=-260
- end ノード: 最もフロー的に自然なレーンに配置する
  - end ノードの配置レーンは必ずしも start と同一でなくてよい
  - 最後に合流するフローの主要レーンに配置する（例: 承認フローの場合はマネージャーレーン）
  - dx=+100, 他のノードと重ならない位置にする

## レーン数に応じた調整

| レーン数 | lane_height | 補足 |
|---|---|---|
| 1-5 | 220 (デフォルト) | |
| 6-10 | 200 | コンパクト化 |
| 11-15 | 180 | さらにコンパクト化 |

## カラム数に応じた調整

| カラム数 | col_width | 補足 |
|---|---|---|
| 1-7 | 420 (デフォルト) | |
| 8-10 | 380 | コンパクト化 |
| 11-15 | 340 | さらにコンパクト化 |

## 日本語フォント幅の見積り根拠

ノードラベルの幅見積りには以下の概算値を使用する:

| 文字種 | 幅 (px) | 根拠 |
|---|---|---|
| 日本語（CJK） | ~16px/文字 (font-size=14) | Miro の既定フォント（Open Sans / Noto Sans）で全角文字を描画した場合の実測値に基づく概算。正確な値はフォントレンダリングに依存するが、14px フォントでの全角文字幅は 14〜18px の範囲に収まる |
| ラテン文字 | ~9px/文字 (font-size=14) | 半角英数字の平均幅。`m` や `w` は約12px、`i` や `l` は約5px |
| フォントサイズ補正 | 比例スケール | font_size / 14.0 の比率で線形スケーリング |

パディング: ノード内部に左右合計 20px のパディングを想定。

これらの値は `scripts/validate_chart.py` の `estimate_text_width()` 関数で使用され、ラベル切れ(truncation)の検出に利用される。

## 逆流エッジ（差戻し・ループ）の扱い

逆流エッジがある場合:
- shape: "curved" を指定して視覚的に区別
- dashed: true で点線表示
- 逆流先のノードに十分な空間があることを確認
- 必要に応じて lane_height を拡大
- 逆流エッジの src/dst ノードは dy オフセットで垂直方向にずらし、直線フローとの重なりを回避する
